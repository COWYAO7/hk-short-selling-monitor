<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="æ¸¯è‚¡å–ç©ºå®Œæ•´åå• - æŸ¥çœ‹æ‰€æœ‰å¯å–ç©ºè¯åˆ¸">
    <title>å®Œæ•´åå• - æ¸¯è‚¡å–ç©ºç›‘æ§</title>

    <link rel="stylesheet" href="css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-container">
                <a href="index.html" class="navbar-brand">
                    <span class="icon">ğŸ“Š</span>
                    <span>æ¸¯è‚¡å–ç©ºç›‘æ§</span>
                </a>
                <ul class="navbar-nav">
                    <li><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                    <li><a href="list.html" class="nav-link">å®Œæ•´åå•</a></li>
                    <li><a href="history.html" class="nav-link">å†å²è®°å½•</a></li>
                    <li><a href="stats.html" class="nav-link">ç»Ÿè®¡åˆ†æ</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">å®Œæ•´åå•</h1>
                <p class="page-subtitle" id="subtitle">æ­£åœ¨åŠ è½½...</p>
            </div>

            <!-- æœç´¢å’Œæ“ä½œæ  -->
            <div class="card mb-3">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="searchInput" class="input" placeholder="ğŸ” æœç´¢è‚¡ç¥¨ä»£å·æˆ–åç§°..."
                        style="flex: 1; min-width: 250px;">
                    <select id="currencyFilter" class="input" style="width: 150px;">
                        <option value="">å…¨éƒ¨è´§å¸</option>
                        <option value="HKD">HKD</option>
                        <option value="CNY">CNY</option>
                        <option value="USD">USD</option>
                    </select>
                    <button class="btn btn-primary" onclick="exportData()">
                        ğŸ“¥ å¯¼å‡ºCSV
                    </button>
                </div>
            </div>

            <!-- è¡¨æ ¼ -->
            <div class="table-container" id="tableContainer">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>

            <!-- åˆ†é¡µ -->
            <div style="text-align: center; margin-top: 2rem;" id="pagination">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </main>

    <footer style="text-align: center; padding: 3rem 0; color: var(--text-muted);">
        <p>æ•°æ®æ¥æºï¼š<a href="https://www.hkex.com.hk" target="_blank" style="color: var(--accent-primary);">é¦™æ¸¯äº¤æ˜“æ‰€</a></p>
    </footer>

    <script src="js/utils.js"></script>
    <script>
        let allStocks = [];
        let filteredStocks = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let sortColumn = 0;
        let sortAscending = true;

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                showLoading('tableContainer');

                const data = await loadJSON('data/current.json');
                allStocks = data.stocks;
                filteredStocks = [...allStocks];

                // æ›´æ–°å‰¯æ ‡é¢˜
                document.getElementById('subtitle').textContent =
                    `ç”Ÿæ•ˆæ—¥æœŸï¼š${formatDate(data.date)} | å…± ${formatNumber(data.total)} åªè‚¡ç¥¨`;

                renderTable();
                renderPagination();

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showError('tableContainer', 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageStocks = filteredStocks.slice(start, end);

            let html = `
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th onclick="sort(0)">æ•°ç›® ${getSortIcon(0)}</th>
                            <th onclick="sort(1)">è‚¡ä»½ä»£å· ${getSortIcon(1)}</th>
                            <th onclick="sort(2)">è‚¡ä»½ç®€ç§° ${getSortIcon(2)}</th>
                            <th onclick="sort(3)">äº¤æ˜“è´§å¸ ${getSortIcon(3)}</th>
                            <th onclick="sort(4)">ç§ç±» ${getSortIcon(4)}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageStocks.forEach(stock => {
                html += `
                    <tr>
                        <td>${stock.number}</td>
                        <td><span class="stock-code">${stock.code}</span></td>
                        <td>${stock.name}</td>
                        <td><span class="badge badge-primary">${stock.currency}</span></td>
                        <td style="color: var(--text-muted); font-size: 0.9rem;">${stock.type}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';

            document.getElementById('tableContainer').innerHTML = html;
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination() {
            const totalPages = Math.ceil(filteredStocks.length / itemsPerPage);

            if (totalPages <= 1) {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            let html = '<div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">';

            // ä¸Šä¸€é¡µ
            if (currentPage > 1) {
                html += `<button class="btn btn-outline" onclick="changePage(${currentPage - 1})">â† ä¸Šä¸€é¡µ</button>`;
            }

            // é¡µç 
            const maxButtons = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            if (startPage > 1) {
                html += `<button class="btn btn-outline" onclick="changePage(1)">1</button>`;
                if (startPage > 2) html += '<span style="padding: 0.5rem;">...</span>';
            }

            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'btn-primary' : 'btn-outline';
                html += `<button class="btn ${active}" onclick="changePage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span style="padding: 0.5rem;">...</span>';
                html += `<button class="btn btn-outline" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            // ä¸‹ä¸€é¡µ
            if (currentPage < totalPages) {
                html += `<button class="btn btn-outline" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ â†’</button>`;
            }

            html += '</div>';
            html += `<p style="margin-top: 1rem; color: var(--text-muted);">ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ | æ˜¾ç¤º ${filteredStocks.length} æ¡ç»“æœ</p>`;

            document.getElementById('pagination').innerHTML = html;
        }

        // åˆ‡æ¢é¡µç 
        function changePage(page) {
            currentPage = page;
            renderTable();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // æ’åº
        function sort(column) {
            if (sortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                sortColumn = column;
                sortAscending = true;
            }

            filteredStocks.sort((a, b) => {
                let aValue, bValue;

                switch (column) {
                    case 0: aValue = parseInt(a.number); bValue = parseInt(b.number); break;
                    case 1: aValue = a.code; bValue = b.code; break;
                    case 2: aValue = a.name; bValue = b.name; break;
                    case 3: aValue = a.currency; bValue = b.currency; break;
                    case 4: aValue = a.type; bValue = b.type; break;
                }

                if (typeof aValue === 'number') {
                    return sortAscending ? aValue - bValue : bValue - aValue;
                }

                return sortAscending
                    ? aValue.localeCompare(bValue, 'zh-CN')
                    : bValue.localeCompare(aValue, 'zh-CN');
            });

            currentPage = 1;
            renderTable();
            renderPagination();
        }

        // è·å–æ’åºå›¾æ ‡
        function getSortIcon(column) {
            if (sortColumn !== column) return 'â†•ï¸';
            return sortAscending ? 'â†‘' : 'â†“';
        }

        // æœç´¢
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const currencyFilter = document.getElementById('currencyFilter');

            const applyFilters = debounce(() => {
                const searchText = searchInput.value.toLowerCase();
                const currency = currencyFilter.value;

                filteredStocks = allStocks.filter(stock => {
                    const matchSearch = !searchText ||
                        stock.code.toLowerCase().includes(searchText) ||
                        stock.name.toLowerCase().includes(searchText);

                    const matchCurrency = !currency || stock.currency === currency;

                    return matchSearch && matchCurrency;
                });

                currentPage = 1;
                renderTable();
                renderPagination();
            }, 300);

            searchInput.addEventListener('input', applyFilters);
            currencyFilter.addEventListener('change', applyFilters);
        });

        // å¯¼å‡ºCSV
        function exportData() {
            const table = document.getElementById('stockTable');
            exportTableToCSV(table, `æ¸¯è‚¡å–ç©ºåå•_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // åŠ è½½æ•°æ®
        loadData();
    </script>
</body>

</html>