<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="æ¸¯è‚¡å–ç©ºåå•å†å²è®°å½• - æŸ¥çœ‹æ‰€æœ‰å˜åŒ–å†å²">
    <title>å†å²è®°å½• - æ¸¯è‚¡å–ç©ºç›‘æ§</title>

    <link rel="stylesheet" href="css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-container">
                <a href="index.html" class="navbar-brand">
                    <span class="icon">ğŸ“Š</span>
                    <span>æ¸¯è‚¡å–ç©ºç›‘æ§</span>
                </a>
                <ul class="navbar-nav">
                    <li><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                    <li><a href="list.html" class="nav-link">å®Œæ•´åå•</a></li>
                    <li><a href="history.html" class="nav-link">å†å²è®°å½•</a></li>
                    <li><a href="stats.html" class="nav-link">ç»Ÿè®¡åˆ†æ</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <div class="container-narrow">
            <div class="page-header">
                <h1 class="page-title">å†å²è®°å½•</h1>
                <p class="page-subtitle" id="subtitle">åŠ è½½ä¸­...</p>
            </div>

            <!-- ç»Ÿè®¡æ‘˜è¦ -->
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="stat-card">
                    <div class="stat-value primary" id="totalChanges">-</div>
                    <div class="stat-label">æ€»å˜åŒ–æ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value success" id="totalAdded">-</div>
                    <div class="stat-label">ç´¯è®¡æ–°å¢</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value danger" id="totalRemoved">-</div>
                    <div class="stat-label">ç´¯è®¡ç§»é™¤</div>
                </div>
            </div>

            <!-- å†å²è®°å½•æ—¶é—´çº¿ -->
            <div id="historyTimeline" class="timeline">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </main>

    <footer style="text-align: center; padding: 3rem 0; color: var(--text-muted);">
        <p>æ•°æ®æ¥æºï¼š<a href="https://www.hkex.com.hk" target="_blank" style="color: var(--accent-primary);">é¦™æ¸¯äº¤æ˜“æ‰€</a></p>
    </footer>

    <script src="js/utils.js"></script>
    <script>
        async function loadData() {
            try {
                showLoading('historyTimeline');

                const historyData = await loadJSON('data/history.json');

                if (!historyData || historyData.length === 0) {
                    showEmpty('historyTimeline', 'æš‚æ— å†å²è®°å½•');
                    document.getElementById('subtitle').textContent = 'ç­‰å¾…ç¬¬ä¸€æ¬¡æ›´æ–°';
                    return;
                }

                // æ›´æ–°ç»Ÿè®¡
                updateStats(historyData);

                // æ¸²æŸ“æ—¶é—´çº¿
                renderTimeline(historyData);

                document.getElementById('subtitle').textContent = `å…±è®°å½• ${historyData.length} æ¬¡å˜åŒ–`;

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showError('historyTimeline', 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function updateStats(historyData) {
            let totalAdded = 0;
            let totalRemoved = 0;

            historyData.forEach(change => {
                totalAdded += change.added.length;
                totalRemoved += change.removed.length;
            });

            document.getElementById('totalChanges').textContent = historyData.length;
            document.getElementById('totalAdded').textContent = totalAdded;
            document.getElementById('totalRemoved').textContent = totalRemoved;
        }

        function renderTimeline(historyData) {
            const timeline = document.getElementById('historyTimeline');

            let html = '';
            historyData.forEach((change, index) => {
                const netChange = change.net_change;
                const netChangeClass = netChange > 0 ? 'text-success' : netChange < 0 ? 'text-danger' : '';
                const netChangeIcon = netChange > 0 ? 'ğŸ“ˆ' : netChange < 0 ? 'ğŸ“‰' : 'â–';

                html += `
                    <div class="timeline-item">
                        <div class="timeline-date">${formatDate(change.date)}</div>
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <span class="badge badge-success">æ–°å¢ ${change.added.length}</span>
                                    <span class="badge badge-danger" style="margin-left: 0.5rem;">ç§»é™¤ ${change.removed.length}</span>
                                </div>
                                <div class="${netChangeClass}" style="font-weight: 600; font-size: 1.1rem;">
                                    ${netChangeIcon} ${netChange > 0 ? '+' : ''}${netChange}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                                <div>æ€»æ•°: ${change.old_total} â†’ ${change.new_total}</div>
                                <div style="text-align: right;">æ—¶é—´: ${formatDateTime(change.timestamp)}</div>
                            </div>
                `;

                // é»˜è®¤æŠ˜å ï¼Œå¯ç‚¹å‡»å±•å¼€
                const detailId = `detail-${index}`;
                html += `
                    <button 
                        class="btn btn-outline" 
                        style="width: 100%; margin-bottom: 1rem;"
                        onclick="toggleDetail('${detailId}')"
                    >
                        æŸ¥çœ‹è¯¦æƒ… â–¼
                    </button>
                    <div id="${detailId}" class="hidden">
                `;

                // æ–°å¢è‚¡ç¥¨
                if (change.added.length > 0) {
                    html += '<div style="margin-bottom: 1rem;">';
                    html += '<div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-green);">ğŸ“ˆ æ–°å¢:</div>';
                    html += '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                    change.added.forEach(stock => {
                        html += `
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 0.5rem; border-radius: 6px;">
                                <span class="stock-code">${stock.code}</span>
                                <span style="margin-left: 0.5rem;">${stock.name}</span>
                                <span class="badge badge-primary" style="margin-left: 0.5rem; font-size: 0.8rem;">${stock.currency}</span>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                // ç§»é™¤è‚¡ç¥¨
                if (change.removed.length > 0) {
                    html += '<div>';
                    html += '<div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-red);">ğŸ“‰ ç§»é™¤:</div>';
                    html += '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                    change.removed.forEach(stock => {
                        html += `
                            <div style="background: rgba(255, 107, 107, 0.1); padding: 0.5rem; border-radius: 6px;">
                                <span class="stock-code">${stock.code}</span>
                                <span style="margin-left: 0.5rem;">${stock.name}</span>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                html += '</div></div></div>';
            });

            timeline.innerHTML = html;
        }

        function toggleDetail(id) {
            const detail = document.getElementById(id);
            detail.classList.toggle('hidden');

            const button = detail.previousElementSibling;
            button.textContent = detail.classList.contains('hidden') ? 'æŸ¥çœ‹è¯¦æƒ… â–¼' : 'æ”¶èµ·è¯¦æƒ… â–²';
        }

        loadData();
    </script>
</body>

</html>